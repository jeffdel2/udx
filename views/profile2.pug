extends layout

block content
  .profile-page
    .container
      h1.profile.text-center-profile User Profile

      if user
        .row.g-4
          // Left Column - User Information & Registered Devices
          .col-md-6
            // User Information Card
            .card.shadow-sm.mb-4
              .card-body
                h4.profile.mb-3 User Information
                .profile-section
                  p
                    strong Name: 
                    | #{user.given_name + " " + user.family_name || 'Parks Guest'}
                  p
                    strong Email: 
                    | #{user.email || 'Not available'}
                  p
                    strong Last Login: 
                    | #{user.last_login || 'Not available'}

            // Registered MFA Card
            .card.shadow-sm
              .card-body
                h4.profile.mb-3 Registered MFA Factors
              
                h6 #{factors.id}

                if factors && factors.length > 0
                  ul.list-unstyled
                    each factor in factors
                      li.device-item.mb-2
                        .device-card.p-2.border.rounded
                          p.mb-1
                            strong Factor Type: 
                          |   #{factor.type || 'Type'}
                          p.mb-0
                            strong Is Verified: 
                          |   #{factor.confirmed || 'N/A'}
                else
                  p.text-muted No registered Factors.
                  text-center.mt-4
                    // button.btn.btn-primary(type="button" onclick="window.location.href='https://nbcu.oktademo.cloud/authorize?audience=https://nbcu.cic-demo-platform.auth0app.com/userinfo&scope=openid&response_type=code&client_id=7BGRPVLlm5s1AeRrNu5I6fwQuhkymwIT&redirect_uri=http://localhost:8080/profile&state=qwhgdiuqwhsw2hdue2bhfdiul2hdlweiuhde&acr_values=http://schemas.openid.net/pape/policies/2007/06/multi-factor'") Click here to enroll
                    button.btn.btn-primary(type="button" onclick=`window.location.href='${issuerUrl}/authorize?audience=${mgmtUrl}/userinfo&scope=openid&response_type=code&client_id=${clientId}&redirect_uri=${appUrl}profile&state=qwhgdiuqwhsw2hdue2bhfdiul2hdlweiuhde&acr_values=http://schemas.openid.net/pape/policies/2007/06/multi-factor'`) Click here to enroll


          // Right Column - Editable Profile Form
          .col-md-6
            .card.shadow-sm
              .card-body
                h4.profile.mb-3 Edit Profile

                form(action="/profile" method="POST")
                
                  .mb-3
                    label(for="given_name") First Name
                    input#given_name.form-control(type="given_name" name="given_name" value=user.given_name placeholder="Enter your first name")
                    
                  .mb-3
                    label(for="family_name") Last Name
                    input#family_name.form-control(type="family_name" name="family_name" value=user.family_name placeholder="Enter your last name")
                    
                  .mb-3
                    label(for="email") Email
                    input#email.form-control(type="email" name="email" value=user.email placeholder="Enter your email")
                  

                  h5.mt-4 Consent Preferences
                  .row.g-2
                    each consent, index in ['privacy', 'consent', 'terms']
                      .col-6
                        .form-check
                          input.form-check-input(
                            type="checkbox"
                            name="consents[]"
                            value=consent
                            checked=user.user_metadata.consents.includes(consent) ? 'checked' : false
                          )
                          label.form-check-label= consent.replace('_', ' ')

                  .text-center.mt-4
                    button.btn.btn-primary(type="submit") Update Profile


        // Purchased Tickets Section
        .row.mt-4
          .col-12
            .card.shadow-sm
              .card-body
                h4.profile.mb-3 My Purchased Tickets
                
                if userPurchasedTickets && userPurchasedTickets.length > 0
                  .purchased-tickets
                    each ticket in userPurchasedTickets
                      .ticket-item.mb-2.p-2.border.rounded.bg-success.bg-opacity-10
                        .d-flex.justify-content-between.align-items-center
                          .ticket-info
                            strong Purchased Ticket: 
                            span.text-success #{ticket.type}
                            br
                            small.text-muted GUID: #{ticket.guid}
                            br
                            small.text-muted Purchased: #{ticket.purchaseDate}
                          .ticket-status
                            small.text-success
                              i.material-symbols-outlined check_circle
                              |  Purchased
                else
                  .text-center.text-muted
                    p.mb-0 No purchased tickets found.

        // Used Tickets Section
        .row.mt-4
          .col-12
            .card.shadow-sm
              .card-body
                h4.profile.mb-3 My Used Tickets
                
                if userUsedTickets && userUsedTickets.length > 0
                  .used-tickets
                    each ticket in userUsedTickets
                      .ticket-item.mb-2.p-2.border.rounded.bg-danger.bg-opacity-10
                        .d-flex.justify-content-between.align-items-center
                          .ticket-info
                            strong Used Ticket: 
                            span.text-danger #{ticket.type}
                            br
                            small.text-muted GUID: #{ticket.guid}
                            br
                            small.text-muted Purchased: #{ticket.purchaseDate}
                          .ticket-status
                            small.text-danger
                              i.material-symbols-outlined done_all
                              |  Used
                else
                  .text-center.text-muted
                    p.mb-0 No used tickets found.

        footer.text-center.mt-4
          p &copy; 2025 - Profile Management System

      else
        p.text-center You are not logged in.
      
